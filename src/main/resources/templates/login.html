<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Brevus Commerce</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Configuração para Tailwind usar classe para dark mode
    tailwind.config = {
        darkMode: 'class',
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 dark:bg-slate-900 flex items-center justify-center min-h-screen transition-colors duration-300">

<div class="fixed top-5 right-5">
  <button id="theme-toggle" class="p-2.5 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all shadow-sm">
    <i id="theme-toggle-dark-icon" class="hidden fa-solid fa-moon"></i>
    <i id="theme-toggle-light-icon" class="hidden fa-solid fa-sun"></i>
  </button>
</div>

<div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100 dark:border-slate-700 transition-colors">
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Bem-vindo</h1>
    <p class="text-slate-500 dark:text-slate-400 mt-2 font-medium">Brevus Commerce API</p>
  </div>

  <div class="grid grid-cols-2 gap-4 mb-6">
    <a th:href="@{/oauth2/authorization/google}"
       class="flex items-center justify-center gap-2 border border-slate-300 dark:border-slate-600 p-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors font-medium text-slate-700 dark:text-slate-200">
      <img src="https://www.svgrepo.com/show/355037/google.svg" class="w-5 h-5" alt="Google">
      Google
    </a>
    <a th:href="@{/oauth2/authorization/facebook}"
       class="flex items-center justify-center gap-2 border border-slate-300 dark:border-slate-600 p-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors font-medium text-slate-700 dark:text-slate-200">
      <i class="fa-brands fa-facebook text-blue-600 text-xl"></i>
      Facebook
    </a>
  </div>

  <div class="relative mb-6">
    <div class="absolute inset-0 flex items-center">
      <div class="w-full border-t border-slate-200 dark:border-slate-700"></div>
    </div>
    <div class="relative flex justify-center text-sm">
      <span class="px-2 bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400">ou e-mail</span>
    </div>
  </div>

  <form id="loginForm" class="space-y-5">
    <div>
      <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">E-mail</label>
      <input type="email" id="email" name="email" required
             class="w-full px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all placeholder:text-slate-400"
             placeholder="exemplo@email.com">
    </div>

    <div>
      <div class="flex justify-between mb-1">
        <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">Senha</label>
      </div>
      <input type="password" id="password" name="password" required
             class="w-full px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all placeholder:text-slate-400"
             placeholder="••••••••">
    </div>

    <div id="errorMessage" class="hidden p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 text-sm"></div>

    <button type="submit" id="submitBtn"
            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 dark:shadow-none disabled:opacity-50 disabled:cursor-not-allowed">
      Entrar na Conta
    </button>
  </form>

  <div class="mt-8 space-y-3 text-center">
    <p class="text-slate-600 dark:text-slate-400 text-sm">
      Não tem uma conta?
      <a href="/api/web/register-user" class="text-indigo-600 dark:text-indigo-400 font-bold hover:underline">Cadastre-se</a>
    </p>
    <p>
      <a href="#" class="text-xs text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 underline decoration-slate-300 underline-offset-4">Esqueceu a senha?</a>
    </p>
  </div>
</div>

<script>
  const loginForm = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const submitBtn = document.getElementById('submitBtn');
  const errorMessage = document.getElementById('errorMessage');

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Desabilitar botão durante requisição
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';
    errorMessage.classList.add('hidden');

    try {
      const response = await fetch('/api/users/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: emailInput.value,
          password: passwordInput.value
        })
      });

      if (response.ok) {
        const token = await response.text();
        // Armazenar o token no localStorage
        localStorage.setItem('authToken', token);

        // Decodificar o JWT para pegar as roles
        const roles = decodeTokenAndGetRoles(token);
        console.log('Roles do usuário:', roles);

        // Redirecionar baseado na role
        let redirectUrl = '/api/web/home-user'; // Default
        if (roles.includes('ADMIN')) {
          redirectUrl = '/api/web/home-manager';
        } else if (roles.includes('CLIENT')) {
          redirectUrl = '/api/web/home-user';
        }

        window.location.href = redirectUrl;
      } else {
        const errorText = await response.text();
        showError('Email ou senha incorretos');
      }
    } catch (error) {
      console.error('Erro:', error);
      showError('Erro ao conectar ao servidor');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Entrar na Conta';
    }
  });

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
  }

  // Função para decodificar JWT e extrair as roles
  function decodeTokenAndGetRoles(token) {
    try {
      // O JWT tem 3 partes separadas por ponto: header.payload.signature
      const parts = token.split('.');

      if (parts.length !== 3) {
        console.error('Token inválido');
        return [];
      }

      // Decodificar a parte payload (segunda parte)
      const payload = parts[1];

      // Adicionar padding se necessário
      const padding = 4 - (payload.length % 4);
      const paddedPayload = padding < 4 ? payload + '='.repeat(padding) : payload;

      // Decodificar de Base64
      const decodedPayload = atob(paddedPayload);

      // Converter para objeto JSON
      const claims = JSON.parse(decodedPayload);

      console.log('Token decodificado:', claims);

      // Extrair as roles (podem estar em diferentes nomes: 'roles', 'authorities', 'role', etc)
      let roles = claims.roles || claims.authorities || claims.role || [];

      // Se roles é uma string, precisa converter
      if (typeof roles === 'string') {
        // Remover colchetes se existirem: "[ADMIN]" -> "ADMIN"
        roles = roles.replace(/[\[\]]/g, '');
        // Dividir por vírgula e espaço em branco: "ADMIN,CLIENT" -> ["ADMIN", "CLIENT"]
        roles = roles.split(',').map(r => r.trim()).filter(r => r.length > 0);
      }

      // Garantir que é um array
      if (!Array.isArray(roles)) {
        roles = [roles];
      }

      console.log('Roles processadas:', roles);
      return roles;
    } catch (error) {
      console.error('Erro ao decodificar token:', error);
      return [];
    }
  }

  const themeToggleBtn = document.getElementById('theme-toggle');
  const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
  const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

  // Checagem inicial de preferência
  if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
      themeToggleLightIcon.classList.remove('hidden');
  } else {
      document.documentElement.classList.remove('dark');
      themeToggleDarkIcon.classList.remove('hidden');
  }

  themeToggleBtn.addEventListener('click', function() {
      // Alterna ícones
      themeToggleDarkIcon.classList.toggle('hidden');
      themeToggleLightIcon.classList.toggle('hidden');

      if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('color-theme', 'light');
      } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('color-theme', 'dark');
      }
  });
</script>
</body>
</html>